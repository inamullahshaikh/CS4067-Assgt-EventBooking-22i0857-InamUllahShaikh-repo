name: Jira Issue Automation

on:
  push:
    branches:
      - main
      - develop
      - feature/*

jobs:
  update-jira:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Extract Jira Issue Keys from Commit Messages
        id: extract-issues
        run: |
          $ISSUES = git log --format=%B -n 1 | Select-String -Pattern 'CE20I-\d+' | ForEach-Object { $_.Matches.Value } | Sort-Object -Unique
          Write-Host "Found Jira Issues: $ISSUES"
          echo "ISSUES=$ISSUES" >> $env:GITHUB_ENV

      - name: Move Issues to In Progress
        if: ${{ env.ISSUES != '' }}
        run: |
          foreach ($ISSUE in $env:ISSUES) {
            curl --request POST `
              --url "https://your-jira-instance.atlassian.net/rest/api/3/issue/$ISSUE/transitions" `
              --user "$env:JIRA_USER:$env:JIRA_API_TOKEN" `
              --header "Accept: application/json" `
              --header "Content-Type: application/json" `
              --data '{"transition": { "id": "11" }}'
          }
        env:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Move Issues to Done if Fixed
        if: contains(github.event.head_commit.message, 'fix') || contains(github.event.head_commit.message, 'resolve')
        run: |
          foreach ($ISSUE in $env:ISSUES) {
            curl --request POST `
              --url "https://your-jira-instance.atlassian.net/rest/api/3/issue/$ISSUE/transitions" `
              --user "$env:JIRA_USER:$env:JIRA_API_TOKEN" `
              --header "Accept: application/json" `
              --header "Content-Type: application/json" `
              --data '{"transition": { "id": "21" }}'
          }
        env:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
